if(function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.download=t()}(this,function(){return function e(t,n,r){function o(e){var t=e.split(/[:;,]/);e=t[1];var n=(t=("base64"==t[2]?atob:decodeURIComponent)(t.pop())).length,r=0,o=new Uint8Array(n);for(r;r<n;++r)o[r]=t.charCodeAt(r);return new c([o],{type:e})}function a(e,t){if("download"in l)return l.href=e,l.setAttribute("download",p),l.className="download-js-link",l.innerHTML="downloading...",l.style.display="none",document.body.appendChild(l),setTimeout(function(){l.click(),document.body.removeChild(l),!0===t&&setTimeout(function(){i.URL.revokeObjectURL(l.href)},250)},66),!0;if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent))return/^data:/.test(e)&&(e="data:"+e.replace(/^data:([\w\/\-\+]+)/,"application/octet-stream")),!window.open(e)&&confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")&&(location.href=e),!0;var n=document.createElement("iframe");document.body.appendChild(n),!t&&/^data:/.test(e)&&(e="data:"+e.replace(/^data:([\w\/\-\+]+)/,"application/octet-stream")),n.src=e,setTimeout(function(){document.body.removeChild(n)},333)}var i=window,s=r||"application/octet-stream",d=!n&&!r&&t,l=document.createElement("a");r=function(e){return String(e)};var c=i.Blob||i.MozBlob||i.WebKitBlob||r,p=n||"download",c=c.call?c.bind(i):Blob;if("true"===String(this)&&(t=[t,s],s=t[0],t=t[1]),d&&2048>d.length&&(p=d.split("/").pop().split("?")[0],l.href=d,-1!==l.href.indexOf(d))){var f=new XMLHttpRequest;return f.open("GET",d,!0),f.responseType="blob",f.onload=function(t){e(t.target.response,p,"application/octet-stream")},setTimeout(function(){f.send()},0),f}if(/^data:([\w+-]+\/[\w+.-]+)?[,;]/.test(t)){if(!(2096103.424<t.length&&c!==r))return navigator.msSaveBlob?navigator.msSaveBlob(o(t),p):a(t);t=o(t),s=t.type||"application/octet-stream"}else if(/([\x80-\xff])/.test(t)){n=0;var u=(d=new Uint8Array(t.length)).length;for(n;n<u;++n)d[n]=t.charCodeAt(n);t=new c([d],{type:s})}if(t=t instanceof c?t:new c([t],{type:s}),navigator.msSaveBlob)return navigator.msSaveBlob(t,p);if(i.URL)a(i.URL.createObjectURL(t),!0);else{if("string"==typeof t||t.constructor===r)try{return a("data:"+s+";base64,"+i.btoa(t))}catch(e){return a("data:"+s+","+encodeURIComponent(t))}(s=new FileReader).onload=function(e){a(this.result)},s.readAsDataURL(t)}return!0}}),void 0===THREE&&"undefined"!=typeof require)var THREE=require("three");THREE.STLExporter=function(){},THREE.STLExporter.prototype={constructor:THREE.STLExporter,parse:function(){var e=new THREE.Vector3,t=new THREE.Matrix3;return function(n){var r="";return r+="solid exported\n",n.traverse(function(n){if(n instanceof THREE.Mesh){if(0==n.visible)return;var o=n.geometry,a=n.matrixWorld,i=n.skeleton,s=n;if(o instanceof THREE.BufferGeometry){var d=o.clone();o=(new THREE.Geometry).fromBufferGeometry(o);for(var l=d.getAttribute("skinIndex"),c=d.getAttribute("skinWeight"),p=d.getAttribute("morphTarget0"),f=0;void 0!==p;)f++,p=d.getAttribute("morphTarget"+f);if(void 0!==l){o.skinIndices=[],o.skinWeights=[],o.morphTargets=[];for(b=0;b<f;b++)o.morphTargets[b]={},o.morphTargets[b].vertices=[];for(v=0;v<o.vertices.length;v++){o.skinIndices.push((new THREE.Vector4).fromAttribute(l,v)),o.skinWeights.push((new THREE.Vector4).fromAttribute(c,v));for(b=0;b<f;b++)o.morphTargets[b].vertices.push((new THREE.Vector3).fromAttribute(d.getAttribute("morphTarget"+b)))}}}if(o instanceof THREE.Geometry){var u=o.vertices,m=o.faces;if(t.getNormalMatrix(a),void 0!==m)for(var v=0,h=m.length;v<h;v++){var g=m[v];e.copy(g.normal).applyMatrix3(t).normalize(),r+="\tfacet normal "+e.x+" "+e.y+" "+e.z+"\n",r+="\t\touter loop\n";for(var y=[g.a,g.b,g.c],b=0;b<3;b++){var T=y[b];if(void 0!==o.skinIndices&&0==o.skinIndices.length)e.copy(u[T]).applyMatrix4(a),r+="\t\t\tvertex "+e.x+" "+e.y+" "+e.z+"\n";else{e.copy(u[T]);var E=[o.skinIndices[T].x,o.skinIndices[T].y,o.skinIndices[T].z,o.skinIndices[T].w],x=[o.skinWeights[T].x,o.skinWeights[T].y,o.skinWeights[T].z,o.skinWeights[T].w],w=[i.boneInverses[E[0]],i.boneInverses[E[1]],i.boneInverses[E[2]],i.boneInverses[E[3]]],R=[i.bones[E[0]].matrixWorld,i.bones[E[1]].matrixWorld,i.bones[E[2]].matrixWorld,i.bones[E[3]].matrixWorld];if("undefined"!==o.morphTargets)for(var k=[],C=[],H=[],S=[],A=0;A<o.morphTargets.length;A++)k[A]=o.morphTargets[A].vertices[T].x,C[A]=o.morphTargets[A].vertices[T].y,H[A]=o.morphTargets[A].vertices[T].z,S[A]=s.morphTargetInfluences[A];var j=new THREE.Vector4;if("undefined"!==s.geometry.morphTargets)for(var I=new THREE.Vector4(e.x,e.y,e.z),A=0;A<o.morphTargets.length;A++)I.lerp(new THREE.Vector4(k[A],C[A],H[A],1),S[A]);for(var L=0;L<4;L++){var W=new THREE.Vector4(e.x,e.y,e.z);W.multiplyScalar(x[L]),W.applyMatrix4(w[L]).applyMatrix4(R[L]),j.add(W)}r+="\t\t\tvertex "+j.x+" "+j.y+" "+j.z+"\n"}}r+="\t\tendloop\n",r+="\tendfacet\n"}}}}),r+="endsolid exported\n"}}()},"undefined"!=typeof module&&module.exports?module.exports=THREE.STLExporter:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define([],function(){return saveAs}),$("#add").css({display:"none"});var stl=$("<a/>").addClass("shop-button").css({margin:"5px","pointer-events":"auto"}).text("Download STL"),sjson=$("<a/>").addClass("shop-button").css({margin:"5px","pointer-events":"auto"}).text("Save JSON"),ljson=$("<input/>").attr({type:"file",id:"ljson"}).css({display:"none"}).text("Load JSON"),labelljson=$("<label/>").attr({for:"ljson"}).addClass("shop-button").css({margin:"5px","pointer-events":"auto"}).text("Load JSON");stl.click(function(e){e.preventDefault();var t,n=new THREE.STLExporter,r=CK.activeCharacter.threeObj.children,o=0;for(t in r)r[t].children.length>r[o].children.length&&(o=t);var a=n.parse(CK.activeCharacter.threeObj.children[o]),i=CK.activeCharacter.name;i=""===i?"unnamed":i,download(a,i+".stl","text/plain")}),sjson.click(function(e){e.preventDefault();var t=JSON.stringify(CK.activeCharacter.characterData),n=CK.activeCharacter.name;n=""===n?"unnamed":n,download(t,n+".json","text/plain")}),ljson.on("change",function(e){e.preventDefault();var t=e.target.files[0],n=new FileReader;n.onload=function(e){e.preventDefault(),CK.change(JSON.parse(e.target.result))},n.readAsText(t)}),$("#print-my-mini").append(stl),$("#print-my-mini").append(sjson),$("#print-my-mini").append(ljson),$("#print-my-mini").append(labelljson);